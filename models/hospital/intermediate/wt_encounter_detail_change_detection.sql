-- models/encounter_detail/wt_encounter_detail_change_detection.sql

{{ config(materialized='view', tags=['change_detection']) }}

WITH source_logic AS (
    SELECT * FROM {{ ref('wt_encounter_detail_source_logic') }}
),

timestamp_unique AS (
    SELECT * FROM {{ ref('wt_encounter_detail_timestamp_unique') }}
),

combined_data AS (
    SELECT
        s.*,
        t.VLD_FR_TS AS UNIQUE_VLD_FR_TS
    FROM source_logic s
    JOIN timestamp_unique t ON s.ENCNT_SK = t.ENCNT_SK AND s.VLD_FR_TS = t.VLD_FR_TS
),

prev_record AS (
    SELECT 
        *,
        LAG(VST_TYPE_CD_SK) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_VST_TYPE_CD_SK,
        LAG(PT_OF_ORIG_CD_SK) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_PT_OF_ORIG_CD_SK,
        LAG(ENCNT_TS) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ENCNT_TS,
        LAG(ADMT_TS) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ADMT_TS,
        LAG(ADMT_CMPLN_TXT) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ADMT_CMPLN_TXT,
        LAG(RE_ADMT_IND) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_RE_ADMT_IND,
        LAG(HSPTL_SRVC_CD_SK) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_HSPTL_SRVC_CD_SK,
        LAG(EXPCT_NUM_OF_INS_PLAN_CNT) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_EXPCT_NUM_OF_INS_PLAN_CNT,
        LAG(ACTL_LEN_OF_STAY_DYS_CNT) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ACTL_LEN_OF_STAY_DYS_CNT,
        LAG(DSCRG_TS) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_DSCRG_TS,
        LAG(DSCRG_STS_CD_SK) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_DSCRG_STS_CD_SK,
        LAG(PTNT_STS_REF_CD) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_PTNT_STS_REF_CD,
        LAG(ADV_DRTCV_PRSNT_TXT) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ADV_DRTCV_PRSNT_TXT,
        LAG(ACCOM_REF_CD) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ACCOM_REF_CD,
        LAG(ALT_ENCNT_TXT) OVER (PARTITION BY ENCNT_SK ORDER BY REC_RANK) AS PREV_ALT_ENCNT_TXT
    FROM combined_data
),

change_detection AS (
    SELECT 
        *,
        CASE
            WHEN REC_RANK = 1 THEN 1
            WHEN COALESCE(CAST(VST_TYPE_CD_SK AS STRING), 'NULL') != COALESCE(CAST(PREV_VST_TYPE_CD_SK AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(PT_OF_ORIG_CD_SK AS STRING), 'NULL') != COALESCE(CAST(PREV_PT_OF_ORIG_CD_SK AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(ENCNT_TS AS STRING), '1900-01-01 00:00:00') != COALESCE(CAST(PREV_ENCNT_TS AS STRING), '1900-01-01 00:00:00') THEN 1
            WHEN COALESCE(CAST(ADMT_TS AS STRING), '1900-01-01 00:00:00') != COALESCE(CAST(PREV_ADMT_TS AS STRING), '1900-01-01 00:00:00') THEN 1
            WHEN COALESCE(ADMT_CMPLN_TXT, '') != COALESCE(PREV_ADMT_CMPLN_TXT, '') THEN 1
            WHEN COALESCE(CAST(RE_ADMT_IND AS STRING), 'NULL') != COALESCE(CAST(PREV_RE_ADMT_IND AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(HSPTL_SRVC_CD_SK AS STRING), 'NULL') != COALESCE(CAST(PREV_HSPTL_SRVC_CD_SK AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(EXPCT_NUM_OF_INS_PLAN_CNT AS STRING), 'NULL') != COALESCE(CAST(PREV_EXPCT_NUM_OF_INS_PLAN_CNT AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(ACTL_LEN_OF_STAY_DYS_CNT AS STRING), 'NULL') != COALESCE(CAST(PREV_ACTL_LEN_OF_STAY_DYS_CNT AS STRING), 'NULL') THEN 1
            WHEN COALESCE(CAST(DSCRG_TS AS STRING), '1900-01-01 00:00:00') != COALESCE(CAST(PREV_DSCRG_TS AS STRING), '1900-01-01 00:00:00') THEN 1
            WHEN COALESCE(CAST(DSCRG_STS_CD_SK AS STRING), 'NULL') != COALESCE(CAST(PREV_DSCRG_STS_CD_SK AS STRING), 'NULL') THEN 1
            WHEN COALESCE(PTNT_STS_REF_CD, '') != COALESCE(PREV_PTNT_STS_REF_CD, '') THEN 1
            WHEN COALESCE(CAST(ADV_DRTCV_PRSNT_TXT AS STRING), 'NULL') != COALESCE(CAST(PREV_ADV_DRTCV_PRSNT_TXT AS STRING), 'NULL') THEN 1
            WHEN COALESCE(ACCOM_REF_CD, '') != COALESCE(PREV_ACCOM_REF_CD, '') THEN 1
            WHEN COALESCE(ALT_ENCNT_TXT, '') != COALESCE(PREV_ALT_ENCNT_TXT, '') THEN 1
            ELSE 0
        END AS IS_CHANGED
    FROM prev_record
),

dense_ranked AS (
    SELECT 
        *,
        DENSE_RANK() OVER (
            PARTITION BY ENCNT_SK 
            ORDER BY UNIQUE_VLD_FR_TS
        ) AS DENSE_REC_RANK
    FROM change_detection
    WHERE IS_CHANGED = 1  -- Only include records that have changed
),

next_valid_from AS (
    SELECT 
        *,
        LEAD(UNIQUE_VLD_FR_TS) OVER (
            PARTITION BY ENCNT_SK 
            ORDER BY DENSE_REC_RANK
        ) AS NEXT_VLD_FR_TS
    FROM dense_ranked
)

SELECT
    ENCNT_SK,
    UNIQUE_VLD_FR_TS AS VLD_FR_TS,
    PATIENT_DW_ID,
    PAT_ACCT_NUM,
    COMPANY_CODE,
    COID,
    COALESCE(
        DATETIME(TIMESTAMP_SUB(NEXT_VLD_FR_TS, INTERVAL 1 MICROSECOND)), 
        DATETIME '9999-12-31 23:59:59.999999'
    ) AS VLD_TO_TS,
    ENCNT_TS,
    ALT_ENCNT_TXT,
    VST_TYPE_CD_SK,
    EHR_MED_REC_NUM,
    EHR_PAT_ACCT_NUM,
    EHR_MED_URN,
    PT_OF_ORIG_CD_SK,
    ADMT_TYPE_REF_CD,
    ADMT_TS,
    ADMT_CMPLN_TXT,
    RE_ADMT_IND,
    HSPTL_SRVC_CD_SK,
    EXPCT_NUM_OF_INS_PLAN_CNT,
    ACTL_LEN_OF_STAY_DYS_CNT,
    EMPMNT_ILLNS_IND,
    ACDNT_AUTO_ST_CD,
    ACDNT_TYPE_REF_CD,
    ACDNT_TS,
    DSCRG_TS,
    DSCRG_STS_CD_SK,
    PTNT_DTH_TS,
    PTNT_DTH_IND,
    PTNT_STS_REF_CD,
    PTNT_CLASS_REF_CD,
    PTNT_STS_EFFV_DT,
    EMR_PTNT_ID_ASSGN_AUTH,
    PRTY_REF_CD,
    SIG_DT,
    ADV_DRTCV_PRSNT_TXT,
    EFFV_FR_DT,
    EFFV_TO_DT,
    TYPE_REF_CD,
    ACCOM_REF_CD,
    SRC_SYS_REF_CD,
    SRC_SYS_UNQ_KEY_TXT,
    CRT_RUN_ID,
    LST_UPDT_RUN_ID,
    MSG_CTRL_ID_TXT,
    MESSAGE_TYPE_TRIGGER_EVENT,
    MESSAGE_TYPE_TRIGGER_EVENT_DIS,
    MESSAGE_TYPE_TRIGGER_EVENT_INS,
    DW_INSRT_TS,
    DENSE_REC_RANK
FROM next_valid_from